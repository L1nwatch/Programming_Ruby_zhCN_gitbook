从 1.8 版本开始，Ruby 内建了 RDoc 工具，它可以提取并格式化嵌套在 Ruby 源代码文件中的文档。该工具被用来为 Ruby 內建的类和模块生成文档。不断增长的库和扩展也使用这种方式来写文档。

RDoc 做两件事情。第一，它分析 Ruby 和 C 源文件以寻找需要文档化的信息。第二，它把得到的这些信息转换成某种方便阅读的格式。RDoc 可以生成两种格式的输出：HTML 和 ri。

如果我们的源代码包括注释，RDoc 会使用它们来丰富产生的文档。通常来说，元素前面的注释被用来生成该元素的文档。

RDoc 也可以生成能被 ri 命令行工具识别的文档。新的 Ruby 发行版中內建的类和模块（以及某些库）都是用这种方式来建立文档的。

### 16.1 向 Ruby 代码中添加 RDoc

RDoc 解析 Ruby 源代码以提取器主要元素（类、模块、方法、属性等等）。通过在文件中的元素前添加注释块，你可以为该元素添加额外的文档。

注释块可以很自然地书写，或者在连续的注释行前加 `#`、或者把注释放到 `=begin` ... `=end` 块中。如果使用第二种形式，`=begin` 行必须带 `rdoc` 标签，以和其他风格的文档相区分。

```ruby
=begin rdoc
xxx
=end
def calculate_path
  # xxx
end
```

在文档注释中，段落中的行具有相同的左边距。缩进超过此空白部分的文本被逐字地格式化。

有些文本可以被标记起来。`_word_`、`*word*` 和 `+word+` 将分别以斜体、粗体和印刷体来显示其中的词。如果想处理多个词或者含有非词字符的文本，你可以用 `<em>xxx</em>`、`<b>xxx</b>`、`<tt>xxx</tt>`。把反斜线加入到内嵌的标记前将使它不被解释。

如果 RDoc 发现注释行以 `#--` 开头，那么它将停止处理注释。这可以用来区分外部注释和内部注释，或者禁止将注释关联到方法、类或模块上。以 `#++` 开头的行重新打开文档处理功能。

```ruby
# xxx
#--
# yyy
#++
# zzz
#--
# ...
def get_dob
  # ...
end
```

#### 16.1.1 超链接

以下画线或减号作前缀的类名、源代码文件以及任何方法名都会自动把注释文本转化成指向它们描述的链接。

以 `http:`、`mailto:`、`ftp:` 和 `www:` 开始的网络链接也能被识别。引用外部图像文件的 HTTP URL 将被转换成内嵌的 `<IMG ...>` 标记。以 `link:` 开头的链接被认为是引用本地文件，且其路径是相对于当前操作路径（即存储输出文件的路径）的相对路径。

超链接也可以是 `label[url]` 形式，在这种情况下 label 是被显示的文本，而 url 是被链接的目标。如果 label 中含有多个词，则可以将它们放到花括号中：`{two words}[url]`

#### 16.1.2 列表

列表是缩进的段落，且带有

*   一个 \* 或者 \- （用于无序列表）
*   后跟一个点的数字，用于编号列表
*   后跟一个点的大写或小写字母，用于字母列表

例如：

```ruby
# xxxx
# * yyyy
# * zzzz
# * 1111
# 22222
```

注意一个列表项中后续的行是如何缩进以和第一行对齐的

带标签的列表（labled list，有时也称为描述列表）使用方括号将标记括起

```ruby
# [cat] small dosxx
# [+cat+] sdasdsadsadas
```

带标签的列表也可以通过在标记后加两个冒号来生成。这将得到表格形式的输出，所以描述都会排列整齐。

```ruby
# cat:: xxxx
# +cat+:: yyyy
```

对两种类型的标记列表而言，如果主体文本的开头和标记在同一行，那么开头的位置决定主体文本剩余部分的缩进量。主体文本也可以从标记的下一行开始，并从标记的开头缩进。这常用在标记比较长的情况下

```ruby
# <tt>--output</tt> <i>name [, name]</i>::
#	specify the name xxxx
# 
#  <tt>....
```

#### 16.1.3 标题

以等于号开头的行表示标题。等于号个数越多，则标题的级别越高。

```ruby
# = Level One
# == Level Two
# and so on..
```

3 个或更多的连字符表示水平线

```ruby
# and so it goes...
# ---
# xxxx
```

#### 16.1.4 文档修饰符

方法的参数列表将被提取出来和方法的描述一块显示。如果一个方法调用 `yield`，那么传递给 `yield` 的参数也将被显示出来。

```ruby
def fred
  # xxx
  yield line, address
end
```

这将产生如下的文档：

```ruby
fred() {|line, address| ... }
```

当方法定义在同一行时，使用含有 `:yields:` 的注释，可以改变这种默认行为：

```ruby
def fred #			#:yields: index, position
  # xxx
  yield line, address
end
```

将获得如下文档：

```ruby
fred() {|index, position| ... }
```

`:yields:` 是一个文档修饰符，其他修饰符包括：`:nodocz:`、`:doc:` 等等

### 16.2 向 C 扩展中添加 RDoc

RDoc 也能理解很多用 C 为 Ruby 写扩展的惯例。

大多数 C 扩展有一个 `Init__Classname` 的方法。RDoc 认为这是类的定义——`Init_` 方法前的任何 C 注释都被当做该类的文档。

`Init_` 函数通常被用来关联 C 函数和 Ruby 方法名。例如，Cipher 扩展可能会定义一个名为 `salt=` 的 Ruby 方法，该方法是通过如下函数来由 C 函数 `salt_set` 实现的。

```ruby
rb_define_method(cCipher, "salt=", salt_set, 1);
```

RDoc 会解析此调用，添加 `salt=` 方法到类文档中。然后搜索函数 `salt_set` 的 C 源代码。如果该函数前面有注释，那么 RDoc 会用该注释作为 `salt` 方法的文档。

然而 RDoc 不能识别相应的 Ruby 方法的调用序列。你可以通过在函数注释中使用 `call-seq` 指令解决此问题。`call-seq` 后面的行（直到空行）被用来文档化方法的调用序列。

可以使用 `Document-class:` 和 `Document-method:` 指令来指明一个 C 注释分别和给定的类或者方法相关联。这两个修饰符以被注释的 Ruby 类或方法的名字作为参数。

最后，也可以在 `Init_` 方法中将 Ruby 方法与处于不同 C 源文件中的 C 函数相关联。但是没有你的帮助，RDoc 也无法找到这个函数。你可以通过为方法调用添加注释来指明包含函数定义的文件。

```c++
rb_define_method(cCipher, "md5", gen_md5, -1);	// in md5.c
```

### 16.3 运行 RDoc

可以用下面的命令来运行 RDoc：

```shell
rdoc [options] [filenames ...]
```

输入 `rdoc --help` 可以得到最新的选项概述。

在生成任何输出之前，将先对文件进行解析，并收集它们所含有的信息。这样就可以处理所有文件之间的交叉索引。如果文件是一个目录，将会遍历其含有的所有文件。如果没有提供文件名，那么会处理当前目录（及其子目录）的所有 Ruby 文件。

典型的用法是为 Ruby 源代码包（例如 RDoc 自身）生成文档。

```shell
rdoc
```

本命令会为当前目录及其子目录内的所有 Ruby 源文件和 C 源文件生成 HTML 文档。这些文档会被存储在 doc/ 子目录下的文档树中。

RDoc 使用文件后缀名来确定如何处理每个文件。名字以 `.rb` 和 `.rbw` 结尾的文件被认为是 Ruby 源文件。以 `.c` 结尾的文件被当做 C 文件来处理。其他所有文件被认为只含有标记（有或者没有 `#` 开头的注释标记）。如果目录名被传递给 RDoc，只递归扫描其中的 C 和 Ruby 源文件。

可以在你的项目目录下创建一个 `.document` 文件。如果 RDoc 进入含有 `.document` 文件的目录，那么 RDoc 仅处理该文件内列出的文件。该文件的每一行可以是文件名、目录名或者是一个通配符（文件系统的 ”glob" 模式）。

#### 16.3.1 为 ri 创建文档

RDoc 也可以创建能被 ri 命令显示的文档。

当你运行 ri 时，默认情况下它会到 3 个地方去搜索文档：

*   system 文档目录
*   site 目录
*   用户的目录

可以使用下面的命令找到本地的 datadir：

```shell
ruby -r rbconfig -e 'p Config::CONFIG["datadir"]'
```

为了添加文档到 ri，你需要告诉 RDoc 使用哪个输出目录。可以使用 `--ri` 选项（for yourself），或者安装文档到系统范围内（`--ri-site`），而 `--ri-system` 仅被用来为 Ruby 內建的类和标准库安装文档。

### 16.4 显示程序用法信息

可以用 `RDoc::usage` 直接从注释命令中将使用说明提取出来显示给用户，而不用在程序的某个地方使用 puts 重复这些消息。

